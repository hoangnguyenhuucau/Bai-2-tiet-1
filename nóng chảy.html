<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>So s√°nh N√≥ng ch·∫£y: K·∫øt tinh vs V√¥ ƒë·ªãnh h√¨nh</title>
<style>
  :root { --bg: #1e1e1e; --panel: #2d2d2d; --accent: #3498db; --fire: #e67e22; }
  body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #eee; margin: 0; height: 100vh; display: flex; overflow: hidden; }

  /* Layout chia 3 c·ªôt: Controls - M√¥ ph·ªèng - ƒê·ªì th·ªã */
  #layout { display: flex; width: 100%; height: 100%; }
  
  /* C·ªôt 1: ƒêi·ªÅu khi·ªÉn */
  #controls { width: 250px; background: var(--panel); padding: 20px; display: flex; flex-direction: column; gap: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); z-index: 10; }
  
  .control-group { background: #333; padding: 15px; border-radius: 8px; }
  h3 { margin: 0 0 10px 0; font-size: 1.1rem; color: var(--accent); }
  label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
  
  /* Switch ch·ªçn lo·∫°i ch·∫•t */
  .type-btn { width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #555; background: #444; color: #aaa; cursor: pointer; transition: 0.2s; border-radius: 4px; }
  .type-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }

  /* Thanh tr∆∞·ª£t ng·ªçn l·ª≠a */
  input[type=range] { width: 100%; cursor: pointer; }
  
  /* N√∫t reset */
  #btn-reset { background: #c0392b; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: auto; }
  #btn-reset:hover { background: #e74c3c; }

  /* C·ªôt 2: M√¥ ph·ªèng H·∫°t */
  #sim-container { flex: 1; position: relative; background: #000; border-right: 1px solid #444; display: flex; flex-direction: column; }
  #particleCanvas { flex: 1; display: block; width: 100%; }
  
  /* H√¨nh ·∫£nh B·∫øp & C·ªëc */
  #lab-setup { height: 150px; background: #111; position: relative; border-top: 1px solid #333; }
  .beaker-base { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 200px; height: 10px; background: #555; border-radius: 5px; }
  .flame { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 40px; height: 0px; background: radial-gradient(ellipse at bottom, #f1c40f 0%, #e67e22 60%, transparent 100%); transition: height 0.2s; filter: blur(2px); opacity: 0.8; border-radius: 50% 50% 20% 20%; }
  .heater-knob { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); color: #888; font-size: 0.8rem; }

  /* C·ªôt 3: ƒê·ªì th·ªã & Nhi·ªát k·∫ø */
  #data-panel { width: 350px; background: #1a1a1a; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
  
  /* Nhi·ªát k·∫ø */
  #thermometer-box { display: flex; align-items: center; gap: 15px; background: #222; padding: 15px; border-radius: 8px; }
  .thermometer-tube { width: 20px; height: 150px; background: #444; border-radius: 10px; position: relative; border: 2px solid #666; overflow: hidden; }
  .thermometer-liquid { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: linear-gradient(to top, #3498db, #e74c3c); transition: height 0.2s; }
  .temp-readout { font-size: 2rem; font-weight: bold; font-family: monospace; color: #e74c3c; }

  /* ƒê·ªì th·ªã Canvas */
  #graph-container { flex: 1; background: #222; border-radius: 8px; position: relative; border: 1px solid #444; }
  #graphCanvas { width: 100%; height: 100%; display: block; }
  .graph-label { position: absolute; top: 10px; left: 10px; font-size: 0.8rem; color: #888; }

</style>
</head>
<body>

<div id="layout">
  <div id="controls">
    <h2>Ph√≤ng Th√≠ Nghi·ªám</h2>
    
    <div class="control-group">
      <h3>1. Ch·ªçn m·∫´u v·∫≠t ch·∫•t</h3>
      <button class="type-btn active" onclick="setMaterial('crystalline')">üíé Ch·∫•t r·∫Øn K·∫æT TINH<br><small>(S·∫Øt, BƒÉng phi·∫øn, N∆∞·ªõc ƒë√°)</small></button>
      <button class="type-btn" onclick="setMaterial('amorphous')">üïØÔ∏è Ch·∫•t r·∫Øn V√î ƒê·ªäNH H√åNH<br><small>(Th·ªßy tinh, Nh·ª±a ƒë∆∞·ªùng, N·∫øn)</small></button>
    </div>

    <div class="control-group">
      <h3>2. Ngu·ªìn Nhi·ªát (B·∫øp)</h3>
      <label>C√¥ng su·∫•t l·ª≠a:</label>
      <input type="range" id="fireSlider" min="0" max="100" value="0">
      <div style="text-align: right; color: var(--fire); font-weight: bold;" id="fireVal">T·∫Øt</div>
    </div>
    
    <div style="font-size: 0.85rem; color: #aaa; line-height: 1.4;">
      <strong>Quan s√°t:</strong>
      <ul style="padding-left: 20px; margin: 5px 0;">
        <li>Theo d√µi ƒë·ªì th·ªã nhi·ªát ƒë·ªô b√™n ph·∫£i.</li>
        <li>K·∫øt tinh: Nhi·ªát ƒë·ªô s·∫Ω <b>d·ª´ng l·∫°i</b> khi ƒëang tan ch·∫£y.</li>
        <li>V√¥ ƒë·ªãnh h√¨nh: Nhi·ªát ƒë·ªô <b>tƒÉng li√™n t·ª•c</b>.</li>
      </ul>
    </div>

    <button id="btn-reset" onclick="resetSim()">L√†m m·ªõi th√≠ nghi·ªám</button>
  </div>

  <div id="sim-container">
    <canvas id="particleCanvas"></canvas>
    
    <div id="lab-setup">
      <div class="beaker-base"></div>
      <div class="flame" id="flameVisual"></div>
      <div class="heater-knob">Ngu·ªìn n√≥ng</div>
      
      <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px; pointer-events: none;">
        <span style="color: #3498db">‚óè R·∫Øn (Li√™n k·∫øt)</span> &nbsp; 
        <span style="color: #e74c3c">‚óè L·ªèng (T·ª± do)</span>
      </div>
    </div>
  </div>

  <div id="data-panel">
    <h3>Nhi·ªát k·∫ø ƒëi·ªán t·ª≠</h3>
    <div id="thermometer-box">
      <div class="thermometer-tube">
        <div class="thermometer-liquid" id="thermoLiquid"></div>
      </div>
      <div>
        <div class="temp-readout" id="tempText">20¬∞C</div>
        <div style="font-size: 0.8rem; color: #888;">Nhi·ªát ƒë·ªô m·∫´u v·∫≠t</div>
      </div>
    </div>

    <h3>ƒê·ªì th·ªã Nhi·ªát ƒë·ªô (T) / Th·ªùi gian (t)</h3>
    <div id="graph-container">
      <canvas id="graphCanvas"></canvas>
      <div class="graph-label">Tr·ª•c tung: Nhi·ªát ƒë·ªô (¬∞C) <br> Tr·ª•c ho√†nh: Th·ªùi gian</div>
    </div>

    <!-- Thuy·∫øt minh l√Ω thuy·∫øt -->
    <div class="control-group" style="margin-top: 15px;">
      <h3>III. Gi·∫£i th√≠ch s·ª± n√≥ng ch·∫£y c·ªßa ch·∫•t r·∫Øn k·∫øt tinh</h3>

      <h4 style="font-size:0.95rem; color:#f1c40f; margin:8px 0 4px;">
        1. Tr∆∞·ªõc khi ƒë·∫°t nhi·ªát ƒë·ªô n√≥ng ch·∫£y
      </h4>
      <p style="font-size:0.85rem; line-height:1.6; margin:4px 0;">
        Khi <u>nung n√≥ng</u> m·ªôt v·∫≠t r·∫Øn k·∫øt tinh, c√°c <b>ph√¢n t·ª≠</b> c·ªßa v·∫≠t r·∫Øn
        <b>nh·∫≠n nhi·ªát l∆∞·ª£ng</b>. NƒÉng l∆∞·ª£ng nhi·ªát n√†y khi·∫øn
        <b>dao ƒë·ªông</b> c·ªßa c√°c ph√¢n t·ª≠ t·∫°i c√°c n√∫t m·∫°ng <b>m·∫°nh l√™n</b>.
        K·∫øt qu·∫£ l√† <b>v·∫≠n t·ªëc chuy·ªÉn ƒë·ªông nhi·ªát</b> c·ªßa c√°c ph√¢n t·ª≠ tƒÉng l√™n ƒë√°ng k·ªÉ.
      </p>

      <h4 style="font-size:0.95rem; color:#f1c40f; margin:10px 0 4px;">
        2. Trong su·ªët qu√° tr√¨nh n√≥ng ch·∫£y (ƒëo·∫°n n·∫±m ngang c·ªßa ƒë·ªì th·ªã)
      </h4>
      <p style="font-size:0.85rem; line-height:1.6; margin:4px 0;">
        Khi nhi·ªát ƒë·ªô ƒë·∫°t gi√° tr·ªã <b>n√≥ng ch·∫£y</b>, c√°c ph√¢n t·ª≠ th·∫Øng ƒë∆∞·ª£c
        <b>l·ª±c li√™n k·∫øt</b> v√† <b>tho√°t kh·ªèi v·ªã tr√≠ c√¢n b·∫±ng</b>.
        ƒê√¢y l√† s·ª± kh·ªüi ƒë·∫ßu qu√° tr√¨nh n√≥ng ch·∫£y.
      </p>
      <p style="font-size:0.85rem; line-height:1.6; margin:4px 0;">
        <b>Nhi·ªát l∆∞·ª£ng</b> cung c·∫•p l√∫c n√†y d√πng ƒë·ªÉ
        <b>ph√° v·ª° li√™n k·∫øt</b> m·∫°ng tinh th·ªÉ n√™n <b>kh√¥ng l√†m tƒÉng nhi·ªát ƒë·ªô</b>
        c·ªßa ch·∫•t. Do ƒë√≥, <b>nhi·ªát ƒë·ªô kh√¥ng ƒë·ªïi</b> trong su·ªët qu√° tr√¨nh n√†y.
      </p>
      <p style="font-size:0.85rem; line-height:1.6; margin:4px 0;">
        Qu√° tr√¨nh k·∫øt th√∫c khi <b>tr·∫≠t t·ª± tinh th·ªÉ</b> b·ªã ph√° v·ª° ho√†n to√†n,
        v·∫≠t chuy·ªÉn th√†nh <b>th·ªÉ l·ªèng</b>.
      </p>
    </div>
  </div>
</div>

<script>
/**
 * C·∫§U H√åNH V·∫¨T L√ù & BI·∫æN TO√ÄN C·ª§C
 */
const pCanvas = document.getElementById('particleCanvas');
const pCtx = pCanvas.getContext('2d');
const gCanvas = document.getElementById('graphCanvas');
const gCtx = gCanvas.getContext('2d');

let particles = [];
let materialType = 'crystalline'; // 'crystalline' ho·∫∑c 'amorphous'

// Th√¥ng s·ªë nhi·ªát ƒë·ªông l·ª±c h·ªçc
let heatPower = 0; // C√¥ng su·∫•t b·∫øp (0-100)
let systemTemp = 20; // Nhi·ªát ƒë·ªô b·∫Øt ƒë·∫ßu (20 ƒë·ªô C)
let latentHeatBuffer = 0; // B·ªô ƒë·ªám ·∫©n nhi·ªát (D√πng cho ch·∫•t k·∫øt tinh)
let time = 0; // Th·ªùi gian m√¥ ph·ªèng
let historyData = []; // D·ªØ li·ªáu v·∫Ω ƒë·ªì th·ªã

// H·∫±ng s·ªë V·∫≠t l√Ω gi·∫£ l·∫≠p
const MELTING_POINT = 80; // Nhi·ªát ƒë·ªô n√≥ng ch·∫£y c·ªßa ch·∫•t k·∫øt tinh
const LATENT_HEAT_CAPACITY = 2000; // C·∫ßn bao nhi√™u nƒÉng l∆∞·ª£ng ƒë·ªÉ ph√° v·ª° ho√†n to√†n li√™n k·∫øt
const BOND_STRENGTH_CRYSTAL = 0.8; // Li√™n k·∫øt m·∫°nh, ƒë·ª©t g√£y d·ª©t kho√°t
const BOND_STRENGTH_AMORPHOUS_MIN = 0.2; // Li√™n k·∫øt y·∫øu
const BOND_STRENGTH_AMORPHOUS_MAX = 0.9; // Li√™n k·∫øt m·∫°nh (ƒëa d·∫°ng)

// Resize canvas
function resize() {
  pCanvas.width = pCanvas.parentElement.offsetWidth;
  pCanvas.height = pCanvas.parentElement.offsetHeight;
  gCanvas.width = gCanvas.parentElement.offsetWidth;
  gCanvas.height = gCanvas.parentElement.offsetHeight;
  if(particles.length === 0) initParticles();
}
window.addEventListener('resize', resize);

/**
 * CLASS H·∫†T
 */
class Particle {
  constructor(x, y, isFixedGrid) {
    this.x = x; this.y = y;
    this.vx = 0; this.vy = 0;
    this.originX = x; this.originY = y; // V·ªã tr√≠ neo (ƒë·ªëi v·ªõi ch·∫•t r·∫Øn)
    
    // Tr·∫°ng th√°i li√™n k·∫øt: true = b·ªã kh√≥a (r·∫Øn), false = t·ª± do (l·ªèng)
    this.isBonded = true; 
    
    // ƒê·ªëi v·ªõi V√¥ ƒë·ªãnh h√¨nh: M·ªói h·∫°t c√≥ nhi·ªát ƒë·ªô n√≥ng ch·∫£y ri√™ng (li√™n k·∫øt m·∫°nh y·∫øu kh√°c nhau)
    // ƒê·ªëi v·ªõi K·∫øt tinh: T·∫•t c·∫£ gi·ªëng nhau
    if (isFixedGrid) {
        this.bondEnergy = 1.0; // ƒê·ªìng nh·∫•t
    } else {
        this.bondEnergy = 0.5 + Math.random() * 0.5; // Ng·∫´u nhi√™n (0.5 - 1.0)
    }
  }
}

/**
 * KH·ªûI T·∫†O H·ªÜ TH·ªêNG
 */
function initParticles() {
  particles = [];
  const rows = 12; const cols = 20;
  const spacing = 25;
  const startX = (pCanvas.width - cols * spacing) / 2 + spacing/2;
  const startY = pCanvas.height - (rows * spacing) - 20;

  for(let r=0; r<rows; r++) {
    for(let c=0; c<cols; c++) {
      let x = startX + c * spacing;
      let y = startY + r * spacing;

      if (materialType === 'crystalline') {
        // K·∫æT TINH: X·∫øp th·∫≥ng h√†ng ngƒÉn n·∫Øp
        // So le m·ªôt ch√∫t ƒë·ªÉ t·∫°o c·∫•u tr√∫c l·ª•c gi√°c b·ªÅn v·ªØng
        if (r % 2 !== 0) x += spacing / 2;
        particles.push(new Particle(x, y, true));
      } else {
        // V√î ƒê·ªäNH H√åNH: X·∫øp l·ªôn x·ªôn (ng·∫´u nhi√™n h√≥a v·ªã tr√≠)
        let randX = (Math.random() - 0.5) * 15;
        let randY = (Math.random() - 0.5) * 15;
        particles.push(new Particle(x + randX, y + randY, false));
      }
    }
  }
}

/**
 * LOGIC V·∫¨T L√ù CH√çNH (LOOP)
 */
function updatePhysics() {
  if (heatPower > 0) {
      // 1. N·∫°p nƒÉng l∆∞·ª£ng v√†o h·ªá th·ªëng
      // NƒÉng l∆∞·ª£ng th√™m v√†o = C√¥ng su·∫•t * H·ªá s·ªë
      let energyInput = heatPower * 0.05; 
      
      if (materialType === 'crystalline') {
          // --- LOGIC CH·∫§T K·∫æT TINH ---
          
          // Ki·ªÉm tra xem ƒë√£ ƒë·∫°t ƒëi·ªÉm n√≥ng ch·∫£y ch∆∞a
          if (systemTemp >= MELTING_POINT) {
              // GIAI ƒêO·∫†N CHUY·ªÇN TH·ªÇ (ƒêO·∫†N N·∫∞M NGANG)
              // Nhi·ªát ƒë·ªô KH√îNG TƒÇNG, nƒÉng l∆∞·ª£ng d√πng ƒë·ªÉ ph√° v·ª° li√™n k·∫øt (·∫®n nhi·ªát)
              
              // ƒê·∫øm s·ªë h·∫°t c√≤n li√™n k·∫øt
              let bondedCount = particles.filter(p => p.isBonded).length;
              
              if (bondedCount > 0) {
                  // ƒê·ªï nƒÉng l∆∞·ª£ng v√†o b·ªô ƒë·ªám
                  latentHeatBuffer += energyInput * 5; // Nh√¢n h·ªá s·ªë ƒë·ªÉ nhanh ƒë·∫ßy
                  
                  // N·∫øu b·ªô ƒë·ªám ƒë·ªß l·ªõn, ph√° v·ª° m·ªôt h·∫°t
                  if (latentHeatBuffer > 10) { 
                      // Ph√° v·ª° ng·∫´u nhi√™n c√°c h·∫°t (M√¥ ph·ªèng tan ch·∫£y t·ª´ ngo√†i v√†o ho·∫∑c ng·∫´u nhi√™n)
                      // T√¨m c√°c h·∫°t c√≤n bond
                      let bondedParticles = particles.filter(p => p.isBonded);
                      if (bondedParticles.length > 0) {
                          // L·∫•y 1 h·∫°t ng·∫´u nhi√™n ph√° v·ª°
                          let p = bondedParticles[Math.floor(Math.random() * bondedParticles.length)];
                          p.isBonded = false;
                      }
                      latentHeatBuffer = 0; // Reset buffer
                  }
                  
                  // QUAN TR·ªåNG: Gi·ªØ nhi·ªát ƒë·ªô dao ƒë·ªông quanh ƒëi·ªÉm n√≥ng ch·∫£y (kh√¥ng tƒÉng)
                  // Th√™m ch√∫t nhi·ªÖu ƒë·ªÉ nh√¨n t·ª± nhi√™n
                  systemTemp = MELTING_POINT + (Math.random() - 0.5); 
                  
              } else {
                  // ƒê√£ tan ch·∫£y h·∫øt -> Nhi·ªát ƒë·ªô ti·∫øp t·ª•c tƒÉng (Ch·∫•t l·ªèng)
                  systemTemp += energyInput * 0.5;
              }
          } else {
              // Ch∆∞a ƒë·∫øn ƒëi·ªÉm n√≥ng ch·∫£y -> TƒÉng nhi·ªát b√¨nh th∆∞·ªùng
              systemTemp += energyInput;
          }
          
      } else {
          // --- LOGIC CH·∫§T V√î ƒê·ªäNH H√åNH ---
          
          // Nhi·ªát ƒë·ªô tƒÉng ƒë·ªÅu, kh√¥ng c√≥ ƒëi·ªÉm d·ª´ng
          systemTemp += energyInput;
          
          // Ph√° v·ª° li√™n k·∫øt D·∫¶N D·∫¶N d·ª±a tr√™n nhi·ªát ƒë·ªô
          // Kh√¥ng c√≥ ƒëi·ªÉm n√≥ng ch·∫£y c·ª• th·ªÉ, nhi·ªát c√†ng cao c√†ng nhi·ªÅu h·∫°t ƒë·ª©t
          particles.forEach(p => {
              if (p.isBonded) {
                  // X√°c su·∫•t ƒë·ª©t g√£y t·ªâ l·ªá v·ªõi nhi·ªát ƒë·ªô hi·ªán t·∫°i
                  // H·∫°t c√≥ bondEnergy th·∫•p s·∫Ω ƒë·ª©t tr∆∞·ªõc
                  let threshold = 40 + p.bondEnergy * 100; // D·∫£i n√≥ng ch·∫£y r·ªông (t·ª´ 40 ƒë·∫øn 140 ƒë·ªô)
                  if (systemTemp > threshold) {
                      p.isBonded = false;
                  }
              }
          });
      }
  } else {
      // T·ª± ngu·ªôi ƒëi n·∫øu t·∫Øt b·∫øp (M·∫•t nhi·ªát ra m√¥i tr∆∞·ªùng)
      if (systemTemp > 20) systemTemp -= 0.1;
  }

  // C·∫≠p nh·∫≠t chuy·ªÉn ƒë·ªông h·∫°t
  particles.forEach(p => {
      // Rung ƒë·ªông nhi·ªát (Vibration)
      let vibration = systemTemp * 0.02;
      p.vx += (Math.random() - 0.5) * vibration;
      p.vy += (Math.random() - 0.5) * vibration;

      if (p.isBonded) {
          // --- H·∫†T R·∫ÆN: B·ªã gi·ªØ b·ªüi l√≤ xo ---
          // L·ª±c ƒë√†n h·ªìi k√©o v·ªÅ v·ªã tr√≠ g·ªëc
          let k = 0.1; // ƒê·ªô c·ª©ng l√≤ xo
          // Ch·∫•t v√¥ ƒë·ªãnh h√¨nh l√≤ xo y·∫øu h∆°n x√≠u
          if (materialType === 'amorphous') k = 0.05;

          p.vx += (p.originX - p.x) * k;
          p.vy += (p.originY - p.y) * k;
          
          // Ma s√°t l·ªõn ƒë·ªÉ gi·ªØ h·∫°t kh√¥ng vƒÉng xa
          p.vx *= 0.8; p.vy *= 0.8;
          
      } else {
          // --- H·∫†T L·ªéNG: T·ª± do ---
          // Tr·ªçng l·ª±c
          p.vy += 0.2;
          
          // Gi·ªõi h·∫°n t·ªëc ƒë·ªô
          let maxSpeed = 2;
          p.vx = Math.max(-maxSpeed, Math.min(maxSpeed, p.vx));
          p.vy = Math.max(-maxSpeed, Math.min(maxSpeed, p.vy));
          
          // Ma s√°t nh·ªõt
          p.vx *= 0.95; p.vy *= 0.95;
      }
      
      // Va ch·∫°m ƒë·∫©y nhau (Repulsion) - ƒê·ªÉ h·∫°t c√≥ th·ªÉ t√≠ch
      particles.forEach(other => {
          if (p === other) return;
          let dx = p.x - other.x;
          let dy = p.y - other.y;
          let distSq = dx*dx + dy*dy;
          if (distSq < 100) { // B√°n k√≠nh t∆∞∆°ng t√°c
              let dist = Math.sqrt(distSq);
              let force = (10 - dist) * 0.2;
              let angle = Math.atan2(dy, dx);
              p.vx += Math.cos(angle) * force;
              p.vy += Math.sin(angle) * force;
          }
      });

      // C·∫≠p nh·∫≠t v·ªã tr√≠
      p.x += p.vx;
      p.y += p.vy;

      // T∆∞·ªùng & S√†n
      if (p.x < 5) { p.x = 5; p.vx *= -0.5; }
      if (p.x > pCanvas.width - 5) { p.x = pCanvas.width - 5; p.vx *= -0.5; }
      if (p.y > pCanvas.height - 5) { p.y = pCanvas.height - 5; p.vy *= -0.5; }
      if (p.y < 5) { p.y = 5; p.vy *= -0.5; }
  });

  // L∆∞u d·ªØ li·ªáu v·∫Ω ƒë·ªì th·ªã
  if (time % 10 === 0) { // C·ª© 10 frame l∆∞u 1 l·∫ßn ƒë·ªÉ ƒë·ª° n·∫∑ng
      historyData.push(systemTemp);
      // Gi·ªõi h·∫°n ƒë·ªô d√†i ƒë·ªì th·ªã, n·∫øu d√†i qu√° th√¨ ƒë·∫©y b·ªõt c√°i c≈©
      if (historyData.length > gCanvas.width) {
          historyData.shift(); // X√≥a ƒë·∫ßu
      }
  }
  time++;
}

/**
 * V·∫º H√åNH
 */
function draw() {
  // 1. V·∫Ω H·∫°t
  pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
  
  particles.forEach(p => {
    pCtx.beginPath();
    pCtx.arc(p.x, p.y, 5, 0, Math.PI*2); // B√°n k√≠nh h·∫°t
    // M√†u s·∫Øc: Xanh (R·∫Øn/Bonded) -> ƒê·ªè (L·ªèng/Free)
    if (p.isBonded) {
        pCtx.fillStyle = '#3498db'; // Xanh
    } else {
        pCtx.fillStyle = '#e74c3c'; // ƒê·ªè
    }
    pCtx.fill();
    
    // V·∫Ω vi·ªÅn b√≥ng cho ƒë·∫πp
    pCtx.strokeStyle = "rgba(255,255,255,0.2)";
    pCtx.stroke();
  });

  // V·∫Ω l∆∞·ªõi li√™n k·∫øt (ch·ªâ cho k·∫øt tinh r·∫Øn)
  if (materialType === 'crystalline') {
      pCtx.strokeStyle = "rgba(255,255,255,0.1)";
      pCtx.beginPath();
      particles.forEach(p => {
          if (!p.isBonded) return;
          // T√¨m h·∫°t h√†ng x√≥m ƒë·ªÉ n·ªëi d√¢y
          particles.forEach(other => {
              if (!other.isBonded || p === other) return;
              let dx = p.x - other.x;
              let dy = p.y - other.y;
              // N·∫øu g·∫ßn nhau th√¨ v·∫Ω d√¢y (kho·∫£ng c√°ch l∆∞·ªõi l√† 25)
              if (Math.abs(dx) < 30 && Math.abs(dy) < 30) {
                  pCtx.moveTo(p.x, p.y);
                  pCtx.lineTo(other.x, other.y);
              }
          });
      });
      pCtx.stroke();
  }

  // 2. C·∫≠p nh·∫≠t UI Nhi·ªát k·∫ø
  let heightPercent = Math.min(100, (systemTemp / 150) * 100);
  document.getElementById('thermoLiquid').style.height = heightPercent + "%";
  document.getElementById('tempText').innerText = Math.round(systemTemp) + "¬∞C";

  // 3. V·∫Ω ƒê·ªì th·ªã
  drawGraph();

  updatePhysics();
  requestAnimationFrame(draw);
}

function drawGraph() {
    gCtx.clearRect(0, 0, gCanvas.width, gCanvas.height);
    
    // V·∫Ω l∆∞·ªõi n·ªÅn ƒë·ªì th·ªã
    gCtx.strokeStyle = "#333";
    gCtx.lineWidth = 1;
    gCtx.beginPath();
    // K·∫ª ngang m·ªëc nhi·ªát ƒë·ªô n√≥ng ch·∫£y (80 ƒë·ªô)
    let meltY = gCanvas.height - (MELTING_POINT / 150) * gCanvas.height;
    gCtx.moveTo(0, meltY);
    gCtx.lineTo(gCanvas.width, meltY);
    gCtx.stroke();
    
    // Ch√∫ th√≠ch m·ªëc 80 ƒë·ªô
    gCtx.fillStyle = "#666";
    gCtx.fillText("80¬∞C", 5, meltY - 5);

    // V·∫Ω ƒë∆∞·ªùng ƒë·ªì th·ªã
    if (historyData.length < 2) return;
    
    gCtx.beginPath();
    gCtx.strokeStyle = "#e67e22"; // M√†u cam l·ª≠a
    gCtx.lineWidth = 2;
    
    for (let i = 0; i < historyData.length; i++) {
        let t = historyData[i];
        let x = i; // M·ªói ƒëi·ªÉm d·ªØ li·ªáu l√† 1 pixel (ho·∫∑c scale l√™n n·∫øu mu·ªën)
        // Map nhi·ªát ƒë·ªô 0-150 ƒë·ªô C v√†o chi·ªÅu cao canvas
        let y = gCanvas.height - (t / 150) * gCanvas.height;
        
        if (i === 0) gCtx.moveTo(x, y);
        else gCtx.lineTo(x, y);
    }
    gCtx.stroke();
    
    // V·∫Ω ƒëi·ªÉm hi·ªán t·∫°i
    let lastX = historyData.length - 1;
    let lastY = gCanvas.height - (systemTemp / 150) * gCanvas.height;
    gCtx.fillStyle = "white";
    gCtx.beginPath();
    gCtx.arc(lastX, lastY, 3, 0, Math.PI*2);
    gCtx.fill();
}


/**
 * X·ª¨ L√ù S·ª∞ KI·ªÜN UI
 */
const fireSlider = document.getElementById('fireSlider');
const fireVal = document.getElementById('fireVal');
const flameVisual = document.getElementById('flameVisual');
const btns = document.querySelectorAll('.type-btn');

fireSlider.addEventListener('input', (e) => {
    heatPower = parseInt(e.target.value);
    // C·∫≠p nh·∫≠t giao di·ªán ng·ªçn l·ª≠a
    if (heatPower === 0) {
        fireVal.innerText = "T·∫Øt";
        flameVisual.style.height = "0px";
    } else {
        fireVal.innerText = heatPower + "%";
        // Chi·ªÅu cao ng·ªçn l·ª≠a t·ªâ l·ªá c√¥ng su·∫•t
        flameVisual.style.height = (heatPower * 0.8) + "px"; 
    }
});

function setMaterial(type) {
    materialType = type;
    // Update n√∫t active
    btns.forEach(b => b.classList.remove('active'));
    if (type === 'crystalline') btns[0].classList.add('active');
    else btns[1].classList.add('active');
    
    resetSim();
}

function resetSim() {
    systemTemp = 20;
    heatPower = 0;
    latentHeatBuffer = 0;
    time = 0;
    historyData = [];
    
    fireSlider.value = 0;
    fireVal.innerText = "T·∫Øt";
    flameVisual.style.height = "0px";
    
    initParticles();
}

// Ch·∫°y
resize();
initParticles();
draw();

</script>
</body>
</html>
